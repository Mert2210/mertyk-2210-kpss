<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mert 2210 - KPSS</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff; text-align: center; margin: 0;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
        }
        .container {
            background: rgba(255,255,255,0.95); color: #333;
            width: 90%; max-width: 450px; padding: 25px;
            border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative; max-height: 90vh; overflow-y: auto;
        }
        h2 { margin-top: 0; color: #1e3c72; letter-spacing: 1px; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; text-align: center; }
        button { background: #1e3c72; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { background: #34568f; }
        button.green { background: #27ae60; }
        button.orange { background: #e67e22; }
        button.red { background: #c0392b; }
        button.gray { background: #95a5a6; color: white; } /* BoÅŸ bÄ±rak butonu iÃ§in */
        button.outline { background: transparent; border: 2px solid #1e3c72; color: #1e3c72; }
        .screen { display: none; } .active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
        
        .list-item { background: #fff; border-bottom: 1px solid #eee; padding: 10px; text-align: left; font-size: 0.9rem; }
        .list-item strong { color: #e67e22; display: block; margin-bottom: 5px; font-size: 0.8rem; }
        .list-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.7rem; margin-right: 5px;}
        
        .player-card { background: #f0f2f5; padding: 10px; margin: 5px 0; border-radius: 5px; display: flex; justify-content: space-between; font-weight: bold; }
        .opt-btn { background: #eef2f3; color: #333; text-align: left; margin-bottom: 8px; border: 2px solid #ddd; }
        .correct { background: #2ecc71 !important; color: white; border-color: #27ae60; }
        .wrong { background: #e74c3c !important; color: white; border-color: #c0392b; }
        .blank-selected { background: #95a5a6 !important; border-color: #7f8c8d; } /* BoÅŸ seÃ§ilince */
        
        #timer-bar { height: 6px; background: #e67e22; width: 100%; margin-top: 15px; border-radius: 3px; }
        .badge { background: #e67e22; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        #q-image { width: 100%; max-height: 200px; object-fit: contain; border-radius: 8px; margin-bottom: 10px; display: none; border: 1px solid #ddd; }
        #star-btn { font-size: 1.5rem; background: none; border: none; color: #ccc; cursor: pointer; padding: 0; width: auto; }
        #star-btn.starred { color: #f1c40f; text-shadow: 0 0 5px #f39c12; }
    </style>
</head>
<body>
<div class="container">
    
    <div id="screen-login" class="screen active">
        <h2>MERT 2210</h2>
        <p>KPSS Bilgi YarÄ±ÅŸmasÄ±</p>
        <input type="text" id="username" placeholder="AdÄ±nÄ±z" maxlength="12">
        <div style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 15px;">
            <button onclick="createRoom()">ğŸ  ODA KUR</button>
            <div style="display:flex; gap:5px;">
                <input type="number" id="room-code-input" placeholder="Oda Kodu" style="margin:0;">
                <button onclick="joinRoom()" class="green" style="margin:0; width:60%;">KATIL</button>
            </div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="showLocalList('fav')" class="outline" style="font-size:0.9rem;">â­ Favorilerim</button>
            <button onclick="showLocalList('wrong')" class="outline" style="font-size:0.9rem;">âŒ YanlÄ±ÅŸlarÄ±m</button>
        </div>
        <button onclick="showScreen('screen-add')" class="outline" style="margin-top:10px; font-size:0.8rem;">â• Soru Ekle</button>
    </div>

    <div id="screen-list" class="screen">
        <h3 id="list-title">Listem</h3>
        <div id="list-content" style="max-height: 300px; overflow-y: auto; background: #f9f9f9; border-radius: 8px; margin-bottom: 10px;"></div>
        <button onclick="clearList()" class="red" style="font-size:0.8rem;">Listeyi Temizle</button>
        <button onclick="showScreen('screen-login')" class="outline">GERÄ° DÃ–N</button>
    </div>

    <div id="screen-add" class="screen">
        <h3>Yeni Soru Ekle</h3>
        <select id="new-ders"><option value="TARÄ°H">Tarih</option><option value="COÄRAFYA">CoÄŸrafya</option><option value="VATANDAÅLIK">VatandaÅŸlÄ±k</option></select>
        <input id="new-soru" placeholder="Soru Metni">
        <input id="new-resim" placeholder="Resim adÄ± veya Linki">
        <input id="new-a" placeholder="A ÅÄ±kkÄ±"><input id="new-b" placeholder="B ÅÄ±kkÄ±"><input id="new-c" placeholder="C ÅÄ±kkÄ±"><input id="new-d" placeholder="D ÅÄ±kkÄ±">
        <select id="new-dogru"><option value="0">DoÄŸru Cevap: A</option><option value="1">DoÄŸru Cevap: B</option><option value="2">DoÄŸru Cevap: C</option><option value="3">DoÄŸru Cevap: D</option></select>
        <button onclick="saveQuestion()" class="green">KAYDET</button>
        <button onclick="showScreen('screen-login')" class="outline">GERÄ° DÃ–N</button>
    </div>

    <div id="screen-lobby" class="screen">
        <p>Oda Kodun:</p>
        <h1 id="display-room-code" style="color:#e67e22; letter-spacing:5px; margin:0;">----</h1>
        <div id="lobby-list" style="margin-top:20px; min-height:50px;"></div>
        <div id="host-controls" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:10px;">
            <label style="font-size:0.8rem; font-weight:bold;">OYUN AYARLARI</label>
            <div style="display:flex; gap:10px; margin-top:5px;">
                <input type="number" id="set-count" value="10" title="Soru SayÄ±sÄ±">
                <input type="number" id="set-duration" value="15" title="SÃ¼re (sn)">
            </div>
            <select id="set-subject"><option value="HEPSI">KarÄ±ÅŸÄ±k (Hepsi)</option><option value="TARÄ°H">Tarih</option><option value="COÄRAFYA">CoÄŸrafya</option><option value="VATANDAÅLIK">VatandaÅŸlÄ±k</option></select>
            <button onclick="startGame()" class="orange">BAÅLAT</button>
        </div>
        <p id="wait-msg" style="display:none; color:#777;">Kurucu bekleniyor...</p>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; align-items:center;">
            <span id="q-lesson" class="badge">DERS</span>
            <button id="star-btn" onclick="toggleStar()">â˜…</button>
            <span id="q-count" style="font-weight:bold; color:#777;">1/10</span>
        </div>
        <img id="q-image" src="" alt="Soru Resmi">
        <h3 id="q-text" style="min-height:60px; margin:10px 0;">Soru...</h3>
        <div id="opts-area"></div>
        
        <button id="btn-blank" onclick="submitBlank()" class="gray" style="margin-top:10px;">âšª BOÅ BIRAK</button>
        
        <div id="timer-bar"></div>
        <div style="margin-top:15px; font-size:0.9rem;">Puanlar: <span id="live-scores"></span></div>
    </div>

    <div id="screen-result" class="screen">
        <h2>ğŸ† SONUÃ‡LAR</h2>
        <div id="result-board"></div><br>
        <button onclick="location.reload()" class="outline">ANA MENÃœYE DÃ–N</button>
    </div>

</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myCode = ""; 
    let myButtons = [];
    let currentQuestionData = null; 
    let currentListType = ""; 

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    
    function getUsername() { 
        const n = document.getElementById('username').value; 
        if(!n) { alert("Ä°sim yazÄ±n!"); return null; } 
        localStorage.setItem('saved_username', n); 
        return n; 
    }
    window.onload = function() {
        const savedName = localStorage.getItem('saved_username');
        if(savedName) document.getElementById('username').value = savedName;
    }
    
    function getLocalData(key) { return JSON.parse(localStorage.getItem(key)) || []; }
    function saveLocalData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

    function toggleStar() {
        if (!currentQuestionData) return;
        const btn = document.getElementById('star-btn');
        let favs = getLocalData('kpss_favs');
        const exists = favs.find(q => q.soru === currentQuestionData.soru);
        if (exists) { favs = favs.filter(q => q.soru !== currentQuestionData.soru); btn.classList.remove('starred'); } 
        else { favs.push(currentQuestionData); btn.classList.add('starred'); }
        saveLocalData('kpss_favs', favs);
    }
    function saveWrongAnswer(qData) {
        let wrongs = getLocalData('kpss_wrongs');
        const exists = wrongs.find(q => q.soru === qData.soru);
        if(!exists) { wrongs.push(qData); saveLocalData('kpss_wrongs', wrongs); }
    }
    function showLocalList(type) {
        currentListType = type;
        const key = type === 'fav' ? 'kpss_favs' : 'kpss_wrongs';
        const title = type === 'fav' ? 'â­ Favori SorularÄ±m' : 'âŒ YanlÄ±ÅŸ YaptÄ±klarÄ±m';
        const list = getLocalData(key);
        document.getElementById('list-title').innerText = title;
        const div = document.getElementById('list-content');
        if(list.length === 0) div.innerHTML = "<p style='padding:20px; color:#999;'>HenÃ¼z kayÄ±tlÄ± soru yok.</p>";
        else div.innerHTML = list.map(q => `<div class="list-item"><span class="list-badge" style="background:${getDersColor(q.ders)}">${q.ders}</span>${q.soru}<strong>Cevap: ${q.siklar[q.dogru]}</strong></div>`).join('');
        showScreen('screen-list');
    }
    function clearList() { if(confirm("Listeyi silmek istiyor musun?")) { localStorage.removeItem(currentListType==='fav'?'kpss_favs':'kpss_wrongs'); showLocalList(currentListType); } }
    function getDersColor(ders) { if(ders === 'TARÄ°H') return '#e74c3c'; if(ders === 'COÄRAFYA') return '#27ae60'; if(ders === 'VATANDAÅLIK') return '#2980b9'; return '#777'; }

    function createRoom() { const n = getUsername(); if(n) socket.emit('createRoom', n); }
    function joinRoom() { const n = getUsername(); const c = document.getElementById('room-code-input').value; if(n && c) { myCode = c; socket.emit('joinRoom', {username:n, roomCode:c}); } else alert("Ä°sim ve Kod gerekli!"); }
    function saveQuestion() {
        const q = { ders: document.getElementById('new-ders').value, soru: document.getElementById('new-soru').value, resim: document.getElementById('new-resim').value, siklar: [document.getElementById('new-a').value, document.getElementById('new-b').value, document.getElementById('new-c').value, document.getElementById('new-d').value], dogru: document.getElementById('new-dogru').value };
        if(!q.soru || !q.siklar[0]) return alert("Eksik bilgi!");
        socket.emit('addNewQuestion', q); document.getElementById('new-soru').value = ""; document.getElementById('new-resim').value = "";
    }
    function startGame() { socket.emit('startGame', { roomCode: myCode, settings: { count: document.getElementById('set-count').value, duration: document.getElementById('set-duration').value, subject: document.getElementById('set-subject').value } }); }
    
    // --- YENÄ°: BOÅ BIRAK FONKSÄ°YONU ---
    function submitBlank() {
        socket.emit('submitAnswer', {roomCode: myCode, answerIndex: -1}); // -1 BoÅŸ demek
        disableAllButtons();
        document.getElementById('btn-blank').innerText = "âšª BoÅŸ BÄ±rakÄ±ldÄ±";
        document.getElementById('btn-blank').classList.add('blank-selected');
    }

    function disableAllButtons() {
        myButtons.forEach(x => x.disabled = true);
        document.getElementById('btn-blank').disabled = true;
    }

    socket.on('roomCreated', c => { myCode = c; document.getElementById('display-room-code').innerText = c; showScreen('screen-lobby'); document.getElementById('host-controls').style.display = 'block'; document.getElementById('wait-msg').style.display = 'none'; });
    socket.on('roomJoined', c => { myCode = c; document.getElementById('display-room-code').innerText = c; showScreen('screen-lobby'); document.getElementById('host-controls').style.display = 'none'; document.getElementById('wait-msg').style.display = 'block'; });
    socket.on('updatePlayerList', p => { document.getElementById('lobby-list').innerHTML = p.map(x => `<div class="player-card"><span>${x.username} ${x.isHost?'ğŸ‘‘':''}</span><span>${x.score}</span></div>`).join(''); document.getElementById('live-scores').innerHTML = p.map(x => `${x.username}:${x.score}`).join(' | '); });

    socket.on('newQuestion', d => {
        showScreen('screen-game'); 
        currentQuestionData = { soru: d.soru, siklar: d.siklar, dogru: null, ders: d.ders }; 
        const favs = getLocalData('kpss_favs'); const isFav = favs.find(q => q.soru === d.soru);
        const starBtn = document.getElementById('star-btn'); if(isFav) starBtn.classList.add('starred'); else starBtn.classList.remove('starred');

        document.getElementById('q-lesson').innerText = d.ders; document.getElementById('q-count').innerText = d.index + " / " + d.total; document.getElementById('q-text').innerText = d.soru;
        const imgEl = document.getElementById('q-image');
        if (d.resim && d.resim.trim() !== "") { if (d.resim.startsWith('http')) imgEl.src = d.resim; else imgEl.src = '/img/' + d.resim; imgEl.style.display = 'block'; } else imgEl.style.display = 'none';

        const div = document.getElementById('opts-area'); div.innerHTML = ""; myButtons = [];
        d.siklar.forEach((s, i) => { 
            const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = s; 
            b.onclick = () => { socket.emit('submitAnswer', {roomCode: myCode, answerIndex: i}); disableAllButtons(); }; 
            div.appendChild(b); myButtons.push(b); 
        });

        // BoÅŸ BÄ±rak butonunu sÄ±fÄ±rla
        const blankBtn = document.getElementById('btn-blank');
        blankBtn.disabled = false; blankBtn.innerText = "âšª BOÅ BIRAK"; blankBtn.classList.remove('blank-selected');

        const bar = document.getElementById('timer-bar'); bar.style.transition = 'none'; bar.style.width = '100%'; setTimeout(() => { bar.style.transition = `width ${d.duration}s linear`; bar.style.width = '0%'; }, 50);
    });

    socket.on('answerResult', d => { 
        if(currentQuestionData) currentQuestionData.dogru = d.correctIndex;
        
        if (d.isBlank) {
            // EÄŸer boÅŸ bÄ±raktÄ±ysa doÄŸru cevabÄ± gÃ¶ster ama yanlÄ±ÅŸ iÅŸaretleme
            myButtons[d.correctIndex].classList.add('correct');
        } else {
            const btn = myButtons[d.selectedIndex]; 
            if(d.correct) btn.classList.add('correct'); 
            else { btn.classList.add('wrong'); myButtons[d.correctIndex].classList.add('correct'); saveWrongAnswer(currentQuestionData); } 
        }
    });

    socket.on('gameOver', p => { showScreen('screen-result'); p.sort((a,b) => b.score - a.score); document.getElementById('result-board').innerHTML = p.map((x,i) => `<div class="player-card"><span>${i+1}. ${x.username}</span><span>${x.score} P</span></div>`).join(''); });
    socket.on('questionAddedSuccess', m => alert(m)); socket.on('errorMsg', m => alert(m));
</script>
</body>
</html>
