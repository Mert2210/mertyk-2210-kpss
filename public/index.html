<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MYK 2210 - KPSS YarÄ±ÅŸmasÄ±</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1e3c72">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; text-align: center; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: rgba(255,255,255,0.95); color: #333; width: 95%; max-width: 450px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; max-height: 95vh; overflow-y: auto; }
        h1, h2, h3 { margin-top: 0; color: #1e3c72; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        button { background: #1e3c72; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button.green { background: #27ae60; }
        button.orange { background: #e67e22; }
        button.red { background: #c0392b; }
        button.purple { background: #8e44ad; }
        button.outline { background: transparent; border: 2px solid #1e3c72; color: #1e3c72; }
        .screen { display: none; } .active { display: block; }
        .list-item { background: #fff; border-bottom: 2px solid #f0f2f5; padding: 12px; text-align: left; font-size: 0.85rem; }
        .list-item .q-text { font-weight: bold; color: #333; display: block; margin-bottom: 5px; }
        .list-item .ans-text { color: #27ae60; font-weight: bold; font-size: 0.8rem; background: #e8f5e9; padding: 4px; border-radius: 4px; display: inline-block; }
        .player-card { background: #f0f2f5; padding: 8px; margin: 4px 0; border-radius: 5px; display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold; }
        .opt-btn { background: #eef2f3; color: #333; text-align: left; border: 2px solid #ddd; width: 100%; margin-bottom: 8px;}
        .correct { background: #2ecc71 !important; color: white; border-color: #27ae60; }
        .wrong { background: #e74c3c !important; color: white; border-color: #c0392b; }
        #timer-bar { height: 6px; background: #e67e22; width: 100%; margin-top: 10px; border-radius: 3px; }
        .badge { background: #e67e22; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        #q-image { width: 100%; max-height: 180px; object-fit: contain; margin-bottom: 10px; display: none; border-radius: 8px; }
        #star-btn { font-size: 1.5rem; background: none; border: none; color: #ccc; width: auto; cursor: pointer; padding: 0; line-height: 1; }
        #star-btn.starred { color: #f1c40f; text-shadow: 0 0 5px rgba(241,196,15,0.5); }
        
        /* CANLI SKOR ALANI STÄ°LÄ° */
        #live-scores-container { margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px; }
        #btn-sound-toggle { font-size: 0.8rem; padding: 5px; margin-top: 10px; }
        
        .review-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .review-q { font-weight: bold; margin-bottom: 10px; color: #1e3c72; }
        .review-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 5px; }
        .review-user-ans { font-weight: bold; }
        .review-correct-ans { color: #27ae60; font-weight: bold; }
        .text-green { color: #27ae60; }
        .text-red { color: #c0392b; }
        .review-solution { background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; font-size: 0.85rem; margin-top: 10px; border-left: 4px solid #ffeeba; }

        /* BRANÅ ANALÄ°ZÄ° STÄ°LÄ° */
        .analysis-card { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-top: 10px; text-align: left; border: 1px solid #e9ecef; }
        .analysis-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #ddd; font-size: 0.85rem; }
        .analysis-item:last-child { border-bottom: none; }

        /* --- YENÄ° EKLENENLER: NAVÄ°GASYON --- */
        #question-navigator {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Yan yana 5 kutu */
            gap: 5px;
            margin-top: 15px;
            padding: 10px;
            background: #f1f2f6;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .nav-box {
            width: 30px; height: 30px;
            display: flex; justify-content: center; align-items: center;
            background: #fff; border: 1px solid #ccc; border-radius: 4px;
            cursor: pointer; font-size: 0.8rem; font-weight: bold; color: #555; transition: 0.2s;
        }
        .nav-box:hover { background: #e0e0e0; }
        .nav-box.active { border: 2px solid #e67e22; transform: scale(1.1); box-shadow: 0 0 5px rgba(230, 126, 34, 0.5); }
        .nav-box.answered { background: #3498db; color: white; border-color: #2980b9; }
        .nav-box.correct { background: #27ae60; color: white; border-color: #2ecc71; }
        .nav-box.wrong { background: #c0392b; color: white; border-color: #e74c3c; }

        /* KÄ°BAR BUTONLAR */
        #nav-buttons { display: flex; justify-content: space-between; margin-top: 15px; gap: 15px; }
        .nav-btn {
            flex: 1; padding: 12px; border: none; border-radius: 12px;
            font-size: 0.95rem; font-weight: 600; cursor: pointer;
            transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .nav-btn.prev { background-color: #f8f9fa; color: #7f8c8d; border: 1px solid #eef2f3; }
        .nav-btn.prev:hover { background-color: #ecf0f1; transform: translateY(-2px); color: #34495e; }
        .nav-btn.next { background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: white; box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3); }
        .nav-btn.next:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4); filter: brightness(1.1); }

        .home-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; transition: 0.2s; padding: 5px; border-radius: 50%; }
        .home-btn:hover { background-color: rgba(0,0,0,0.05); transform: scale(1.1); }
        
        #report-btn { font-size: 1.2rem; background: none; border: none; cursor: pointer; padding: 0; line-height: 1; margin-left: 5px; }
        #report-btn:hover { transform: scale(1.1); }
    </style>
</head>
<body>

<audio id="snd-correct" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3" preload="auto"></audio>
<audio id="snd-wrong" src="https://assets.mixkit.co/active_storage/sfx/2021/2021-preview.mp3" preload="auto"></audio>

<div class="container">
    <div id="screen-login" class="screen active">
        <h1 style="margin: 0; color: #e67e22; letter-spacing: 2px; font-size: 2.5rem;">MYK 2210</h1>
        <h3 style="margin: 5px 0 20px 0; font-weight: normal; font-size: 0.9rem; opacity: 0.9; color: #1e3c72;">KPSS SORU Ã‡Ã–ZME YARIÅMASI</h3>
        
        <input type="text" id="username" placeholder="AdÄ±nÄ±z">
        <button onclick="startTrial()" class="purple">ğŸ“ HIZLI DENEME Ã‡Ã–Z</button>
        <button onclick="createRoom()">ğŸ  ODA KUR (ARKADAÅINLA)</button>
        
        <div style="display:flex; gap:5px;">
            <input type="number" id="room-code-input" placeholder="Oda Kodu">
            <button onclick="joinRoom()" class="green" style="width:60%;">KATIL</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
            <button onclick="showLocalList('fav')" class="outline" style="font-size:0.75rem;">â­ YÄ±ldÄ±zlÄ±lar</button>
            <button onclick="showLocalList('wrong')" class="outline" style="font-size:0.75rem;">âŒ YanlÄ±ÅŸlar</button>
            <button onclick="showLocalList('blank')" class="outline" style="font-size:0.75rem;">âšª BoÅŸlarÄ±m</button>
            <button onclick="startMistakesTrial()" class="red" style="font-size:0.75rem;">ğŸ§  Hata SÄ±navÄ±</button>
        </div>

        <button id="btn-sound-toggle" onclick="toggleSound()" class="outline">ğŸ”Š SES: AÃ‡IK</button>
    </div>

    <div id="screen-list" class="screen">
        <h3 id="list-title">Liste</h3>
        <div id="list-content" style="max-height: 350px; overflow-y: auto;"></div>
        <button onclick="clearList()" class="red" style="margin-top:10px;">Temizle</button>
        <button onclick="showScreen('screen-login')" class="outline">ANA MENÃœ</button>
    </div>

    <div id="screen-lobby" class="screen">
        <p id="room-info-text">Oda Kodu:</p>
        <h1 id="display-room-code" style="color:#e67e22; margin:0;">----</h1>
        <div id="lobby-list" style="margin-top:10px;"></div>
        
        <div id="host-controls" style="display:none; margin-top:20px; background: #f9f9f9; padding: 15px; border-radius: 10px;">
            <h3 style="font-size: 1rem; margin-bottom: 10px;">SÄ±nav AyarlarÄ±</h3>
            
            <div style="display:flex; gap:5px; align-items: flex-end; margin-bottom: 8px;">
                <div style="flex:1;">
                    <span style="font-size:0.7rem; color:#666;">SÃ¼re Modu</span>
                    <select id="set-timer-mode" onchange="toggleTimerInput()" style="font-size:0.8rem; padding:8px;">
                        <option value="question">Soru BaÅŸÄ±na (Saniye)</option>
                        <option value="general">Genel SÄ±nav (Dakika)</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <span id="label-duration" style="font-size:0.7rem; color:#666;">SÃ¼re (Sn)</span>
                    <input type="number" id="set-duration" value="20" style="padding:8px;">
                </div>
            </div>

            <div style="display:flex; gap:5px; align-items: flex-end; margin-bottom: 8px;">
                <div style="flex:1;">
                    <span style="font-size:0.7rem; color:#666;">Soru SayÄ±sÄ±</span>
                    <input type="number" id="set-count" value="10" style="padding:8px;">
                </div>
            </div>
            
            <select id="set-deneme" style="border: 2px solid #e67e22; color: #e67e22; font-weight:bold;">
                <option value="HEPSI">KarÄ±ÅŸÄ±k (TÃ¼m Havuzdan)</option>
            </select>
            
            <select id="set-subject">
                <option value="HEPSI">TÃ¼m Dersler</option>
                <option value="TARÄ°H">Tarih</option>
                <option value="COÄRAFYA">CoÄŸrafya</option>
                <option value="VATANDAÅLIK">VatandaÅŸlÄ±k</option>
                <option value="GÃœNCEL BÄ°LGÄ°LER">GÃ¼ncel Bilgiler</option>
            </select>
            
            <select id="set-difficulty">
                <option value="HEPSI">TÃ¼m Seviyeler</option>
                <option value="KOLAY">Kolay</option>
                <option value="ORTA">Orta</option>
                <option value="ZOR">Zor</option>
                <option value="Ã‡IKMIÅ">ğŸ”¥ Sadece Ã‡Ä±kmÄ±ÅŸ Sorular</option>
            </select>

            <select id="set-sik-sayisi" style="border: 2px solid #2980b9; color: #2980b9; font-weight:bold;">
                <option value="HEPSI">KarÄ±ÅŸÄ±k (TÃ¼m Sorular)</option>
                <option value="4">BaÅŸlangÄ±Ã§ SorularÄ± (4 ÅÄ±klÄ±)</option>
                <option value="5">Yeni Nesil Sorular (5 ÅÄ±klÄ±)</option>
            </select>

            <button onclick="startGame()" class="orange" style="margin-top:10px;">SINAVI BAÅLAT</button>
        </div>
        <p id="wait-msg" style="display:none; color:#777;">Kurucu ayarlarÄ± yapÄ±yor...</p>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="finishExamEarly()" class="home-btn" title="SÄ±navÄ± Bitir">ğŸ</button>
                <span id="q-lesson" class="badge">DERS</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
                <button id="report-btn" onclick="reportCurrentQuestion()" title="HatalÄ± Soru Bildir">âš ï¸</button>
                <button id="star-btn" onclick="toggleStar()">â˜…</button>
                <span id="q-count" style="font-weight:bold;">1/10</span>
            </div>
        </div>
        
        <div id="question-navigator" style="display:none;"></div> 

        <img id="q-image" src="">
        <h3 id="q-text" style="font-size:1.1rem; margin:15px 0; text-align: left;">Soru...</h3>
        <div id="opts-area"></div>
        
        <div id="nav-buttons" style="display:none;">
            <button onclick="navigateQuestion(-1)" class="nav-btn prev">
                <span>â®</span> Ã–nceki
            </button>
            <button onclick="navigateQuestion(1)" class="nav-btn next">
                Sonraki <span>â¯</span>
            </button>
        </div>

        <button id="btn-blank" onclick="submitBlank()" style="background:#95a5a6; margin-top:15px; width:100%; border-radius:8px;">âšª BOÅ BIRAK</button>
        
        <div id="timer-bar"></div>
        <div id="general-timer-display" style="display:none; text-align:center; font-size:1.5rem; font-weight:bold; color:#1e3c72; margin-top:10px;">
            â±ï¸ <span id="gen-timer-val">00:00</span>
        </div>

        <div id="result-msg" style="height: 20px; margin-top: 10px; font-weight: bold; color: #e67e22;"></div>

        <div id="live-scores-container">
            <h4 style="margin:0 0 5px 0; font-size:0.8rem; color:#1e3c72; text-align:left; border-bottom: 1px solid #ddd;">ğŸ“Š CANLI SKORLAR</h4>
            <div id="live-scores-list"></div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <h2>ğŸ† SONUÃ‡LAR</h2>
        <div id="result-board"></div> <div class="analysis-card" id="branch-analysis"></div>
        <br>
        
        <button onclick="showReviewScreen()" class="orange" style="margin-bottom: 10px;">ğŸ” SORULARI Ä°NCELE & Ã‡Ã–ZÃœMLER</button>
        <button onclick="location.reload()" class="outline">ANA MENÃœYE DÃ–N</button>
    </div>

    <div id="screen-review" class="screen">
        <h3>ğŸ“ Soru Ã‡Ã¶zÃ¼mleri</h3>
        <div id="review-content" style="max-height: 60vh; overflow-y: auto; padding-right: 5px;"></div>
        <button onclick="showScreen('screen-result')" class="outline" style="margin-top: 15px;">â¬…ï¸ SONUÃ‡LARA DÃ–N</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io({ transports: ["polling", "websocket"] });
    let myCode = "", myButtons = [], currentQuestionData = null, currentListType = "";
    let isSoundEnabled = localStorage.getItem('kpss_sound') !== 'false';
    let isTrialMode = false, isMistakeMode = false, gameHistory = [];
    
    let questionStatusList = []; 
    let globalTimerInterval = null;

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function getUsername() { return document.getElementById('username').value || null; }
    
    window.onload = function() { 
        const savedName = localStorage.getItem('saved_username'); 
        if(savedName) document.getElementById('username').value = savedName; 
        updateSoundUI();
    }

    function toggleSound() { isSoundEnabled = !isSoundEnabled; localStorage.setItem('kpss_sound', isSoundEnabled); updateSoundUI(); }
    function updateSoundUI() { document.getElementById('btn-sound-toggle').innerText = isSoundEnabled ? "ğŸ”Š SES: AÃ‡IK" : "ğŸ”‡ SES: KAPALI"; }
    function playSnd(id) { if(isSoundEnabled) document.getElementById(id).play().catch(()=>{}); }

    function getLocalData(key) { return JSON.parse(localStorage.getItem(key)) || []; }
    function saveLocalData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    
    function saveToHistory(qData, listKey) {
        let list = getLocalData(listKey);
        const idx = list.findIndex(q => q.soru === qData.soru);
        if(idx === -1) { list.push({...qData}); saveLocalData(listKey, list); }
        else if (qData.dogru !== null) { list[idx] = {...qData}; saveLocalData(listKey, list); }
    }

    function toggleStar() { if (!currentQuestionData) return; const btn = document.getElementById('star-btn'); let favs = getLocalData('kpss_favs'); const idx = favs.findIndex(q => q.soru === currentQuestionData.soru); if (idx > -1) { favs.splice(idx, 1); btn.classList.remove('starred'); } else { favs.push({...currentQuestionData}); btn.classList.add('starred'); } saveLocalData('kpss_favs', favs); }

    // YENÄ°: Hata Bildirme Fonksiyonu
    function reportCurrentQuestion() {
        if (!currentQuestionData) return;
        const reason = prompt("Bu sorudaki hata nedir? (Ã–rn: Cevap anahtarÄ± yanlÄ±ÅŸ, YazÄ±m hatasÄ± vb.)");
        if (reason) {
            socket.emit('reportQuestion', {
                soru: currentQuestionData.soru,
                deneme: currentQuestionData.deneme,
                reason: reason,
                username: getUsername() || "Anonim"
            });
            alert("TeÅŸekkÃ¼rler! Hata bildirimi alÄ±ndÄ±.");
        }
    }

    function showLocalList(type) {
        currentListType = type;
        const list = getLocalData(type==='fav'?'kpss_favs':(type==='wrong'?'kpss_wrongs':'kpss_blanks'));
        document.getElementById('list-title').innerText = type==='fav'?'â­ YÄ±ldÄ±zlÄ±lar':(type==='wrong'?'âŒ YanlÄ±ÅŸlar':'âšª BoÅŸlarÄ±m');
        document.getElementById('list-content').innerHTML = list.length ? list.map(q => `<div class="list-item"><span class="q-text">${q.soru}</span><span class="ans-text">âœ… Cevap: ${q.siklar ? q.siklar[q.dogru] : '?'}</span></div>`).join('') : "<p>KayÄ±t yok.</p>";
        showScreen('screen-list');
    }

    function clearList() { if(confirm("Silinsin mi?")) { localStorage.removeItem(currentListType==='fav'?'kpss_favs':(currentListType==='wrong'?'kpss_wrongs':'kpss_blanks')); showLocalList(currentListType); } }

    function createRoom() { const n = getUsername(); if(n) { localStorage.setItem('saved_username', n); isTrialMode=false; isMistakeMode=false; socket.emit('createRoom', n); } else alert("Ä°sim giriniz!"); }
    
    function startTrial() { const n = getUsername(); if(n) { localStorage.setItem('saved_username', n); isTrialMode=true; isMistakeMode=false; socket.emit('createRoom', n); } else alert("Ä°sim giriniz!"); }
    
    function startMistakesTrial() {
        const n = getUsername();
        const wrongs = getLocalData('kpss_wrongs');
        if(!n) return alert("Ä°sim giriniz!");
        if(wrongs.length < 3) return alert("Hatalardan sÄ±nav yapmak iÃ§in en az 3 yanlÄ±ÅŸ sorunuz olmalÄ±!");
        localStorage.setItem('saved_username', n);
        isTrialMode = true;
        isMistakeMode = true;
        socket.emit('createRoom', n);
    }

    function joinRoom() { const n = getUsername(), c = document.getElementById('room-code-input').value; if(n && c) { localStorage.setItem('saved_username', n); isTrialMode=false; myCode = c; socket.emit('joinRoom', {username:n, roomCode:c}); } }
    
    function toggleTimerInput() {
        const mode = document.getElementById('set-timer-mode').value;
        const label = document.getElementById('label-duration');
        const input = document.getElementById('set-duration');
        
        if(mode === 'general') {
            label.innerText = "Toplam SÃ¼re (Dakika)";
            input.value = "30"; 
        } else {
            label.innerText = "Soru BaÅŸÄ±na (Saniye)";
            input.value = "20"; 
        }
    }

    function startGame() { 
        let settings = { 
            deneme: document.getElementById('set-deneme').value, 
            count: document.getElementById('set-count').value, 
            timerMode: document.getElementById('set-timer-mode').value, 
            duration: document.getElementById('set-duration').value, 
            subject: document.getElementById('set-subject').value, 
            difficulty: document.getElementById('set-difficulty').value,
            sikSayisi: document.getElementById('set-sik-sayisi').value 
        };
        
        if(isMistakeMode) {
            settings.isMistakeMode = true;
            settings.mistakeList = getLocalData('kpss_wrongs').map(q => q.soru);
        }

        socket.emit('startGame', { roomCode: myCode, settings: settings }); 
    }

    function finishExamEarly() {
        if(confirm("SÄ±navÄ± bitirip sonuÃ§ ekranÄ±na gitmek istiyor musun?")) {
            socket.disconnect(); 
            socket.connect(); 
            
            let totalScore = 0;
            gameHistory.forEach(g => {
                if(g.earnedPoints) totalScore += g.earnedPoints;
                else if(g.userAnswerIndex !== -1 && !g.isCorrect) totalScore -= 5;
            });

            renderResultScreen([{ 
                username: getUsername() || "Ben", 
                score: totalScore 
            }]);
        }
    }

    function submitBlank() { socket.emit('submitAnswer', {roomCode: myCode, answerIndex: -1}); disableAllButtons(); }
    function disableAllButtons() { myButtons.forEach(x => x.disabled = true); document.getElementById('btn-blank').disabled = true; }

    function showReviewScreen() {
        const container = document.getElementById('review-content');
        container.innerHTML = "";
        if (gameHistory.length === 0) { container.innerHTML = "<p>Veri yok.</p>"; showScreen('screen-review'); return; }
        gameHistory.forEach((item, index) => {
            const q = item.question;
            const userAns = item.userAnswerIndex === -1 ? "BOÅ" : q.siklar[item.userAnswerIndex];
            const correctAns = q.siklar[item.correctAnswerIndex];
            const statusClass = item.isCorrect ? "text-green" : "text-red";
            const statusIcon = item.isCorrect ? "âœ…" : (item.userAnswerIndex === -1 ? "âšª" : "âŒ");
            const solutionHTML = q.cozum ? `<div class="review-solution">ğŸ’¡ <b>Ã‡Ã¶zÃ¼m:</b> ${q.cozum}</div>` : "";
            container.innerHTML += `<div class="review-card"><div class="review-q">${index + 1}. ${q.soru}</div><div class="review-row"><span>Senin CevabÄ±n:</span><span class="${statusClass} review-user-ans">${statusIcon} ${userAns}</span></div><div class="review-row"><span>DoÄŸru Cevap:</span><span class="review-correct-ans">${correctAns}</span></div>${solutionHTML}</div>`;
        });
        showScreen('screen-review');
    }

    function renderResultScreen(playerList) {
        showScreen('screen-result');
        clearInterval(globalTimerInterval); 

        playerList.sort((a,b) => b.score - a.score);
        document.getElementById('result-board').innerHTML = playerList.map((x,i) => 
            `<div class="player-card"><span>${i+1}. ${x.username}</span><span>${x.score} P</span></div>`
        ).join('');
        
        const stats = {};
        gameHistory.forEach(item => {
            const ders = item.question.ders || "Genel";
            if(!stats[ders]) stats[ders] = { dogru: 0, toplam: 0 };
            stats[ders].toplam++;
            if(item.isCorrect) stats[ders].dogru++;
        });

        let analysisHTML = "<h4 style='margin:0 0 10px 0; color:#1e3c72;'>ğŸ“Š BranÅŸ BaÅŸarÄ± Analizi</h4>";
        if(Object.keys(stats).length === 0) analysisHTML += "<p>Veri yok.</p>";
        else {
            for(let ders in stats) {
                const yuzde = Math.round((stats[ders].dogru / stats[ders].toplam) * 100);
                const color = yuzde >= 70 ? "#27ae60" : (yuzde >= 40 ? "#e67e22" : "#c0392b");
                analysisHTML += `<div class="analysis-item"><span>${ders}</span><span style="color:${color}; font-weight:bold;">%${yuzde} BaÅŸarÄ± (${stats[ders].dogru}/${stats[ders].toplam})</span></div>`;
            }
        }
        document.getElementById('branch-analysis').innerHTML = analysisHTML;
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
    }

    function renderNavigator(total, currentIndex) {
        const navDiv = document.getElementById('question-navigator');
        navDiv.innerHTML = "";
        
        for(let i=0; i<total; i++) {
            const box = document.createElement('div');
            box.className = 'nav-box';
            box.innerText = i + 1;
            
            if(i === currentIndex) box.classList.add('active');
            
            if(questionStatusList[i]) {
                if(questionStatusList[i].result === 'correct') box.classList.add('correct');
                else if(questionStatusList[i].result === 'wrong') box.classList.add('wrong');
                else box.classList.add('answered');
            }

            box.onclick = () => {
                if(isTrialMode) socket.emit('jumpToQuestion', { roomCode: myCode, index: i });
            };
            
            navDiv.appendChild(box);
        }
    }

    function navigateQuestion(direction) {
        if(!currentQuestionData) return;
        const targetIndex = (currentQuestionData.index - 1) + direction;
        socket.emit('jumpToQuestion', { roomCode: myCode, index: targetIndex });
    }

    function startGlobalCountdown(seconds) {
        clearInterval(globalTimerInterval);
        let timeLeft = seconds;
        function updateDisplay() {
            let m = Math.floor(timeLeft / 60);
            let s = timeLeft % 60;
            document.getElementById('gen-timer-val').innerText = `${m}:${s < 10 ? '0'+s : s}`;
        }
        updateDisplay();
        globalTimerInterval = setInterval(() => {
            timeLeft--;
            updateDisplay();
            if(timeLeft <= 0) clearInterval(globalTimerInterval);
        }, 1000);
    }

    socket.on('roomCreated', c => { 
        myCode = c; 
        document.getElementById('display-room-code').innerText = isTrialMode ? (isMistakeMode ? "HATA ANALÄ°Z" : "BÄ°REYSEL DENEME") : c; 
        document.getElementById('room-info-text').innerText = isTrialMode ? "Mod:" : "Oda Kodu:";
        showScreen('screen-lobby'); 
        document.getElementById('host-controls').style.display = 'block'; 
        if(isTrialMode) {
            document.getElementById('wait-msg').style.display = 'none';
            document.getElementById('set-deneme').disabled = isMistakeMode;
            if(isMistakeMode) {
                document.getElementById('set-count').value = Math.min(10, getLocalData('kpss_wrongs').length);
            }
        }
    });
    
    // YENÄ°: Otomatik Deneme Listesi
    socket.on('updateDenemeList', (liste) => {
        const select = document.getElementById('set-deneme');
        select.innerHTML = '<option value="HEPSI">KarÄ±ÅŸÄ±k (TÃ¼m Havuzdan)</option>';
        liste.forEach(denemeAdi => {
            const opt = document.createElement('option');
            opt.value = denemeAdi;
            opt.innerText = denemeAdi; 
            select.appendChild(opt);
        });
    });
    
    socket.on('roomJoined', c => { myCode=c; document.getElementById('display-room-code').innerText=c; showScreen('screen-lobby'); document.getElementById('wait-msg').style.display='block'; });
    
    socket.on('updatePlayerList', p => { 
        const h = p.map(x => `<div class="player-card"><span>${x.username}</span><span>${x.score}</span></div>`).join(''); 
        document.getElementById('lobby-list').innerHTML = isTrialMode ? "" : h; 
        document.getElementById('live-scores-list').innerHTML = h; 
    });

    socket.on('newQuestion', d => {
        if (d.index === 1) { 
            gameHistory = []; 
            questionStatusList = new Array(d.total).fill(null); 
        } 
        
        showScreen('screen-game');
        document.getElementById('result-msg').innerText = "";
        currentQuestionData = { ...d, dogru: null };
        
        if(isTrialMode) {
            document.getElementById('question-navigator').style.display = 'grid'; 
            document.getElementById('nav-buttons').style.display = 'flex'; 
            document.getElementById('live-scores-container').style.display = 'none'; 
            renderNavigator(d.total, d.index - 1);
        } else {
            document.getElementById('question-navigator').style.display = 'none';
            document.getElementById('nav-buttons').style.display = 'none';
            document.getElementById('live-scores-container').style.display = 'block';
        }

        document.getElementById('star-btn').classList.toggle('starred', !!getLocalData('kpss_favs').find(q => q.soru === d.soru));
        document.getElementById('q-lesson').innerText = d.ders + (d.zorluk ? ` (${d.zorluk})` : "");
        document.getElementById('q-count').innerText = d.index + "/" + d.total;
        document.getElementById('q-text').innerText = d.soru;
        const img = document.getElementById('q-image');
        if(d.resim) { img.src = d.resim.startsWith('http') ? d.resim : '/img/' + d.resim; img.style.display = 'block'; } else { img.style.display = 'none'; }
        
        const area = document.getElementById('opts-area'); area.innerHTML = ""; myButtons = [];
        d.siklar.forEach((s, i) => { 
            const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = s; 
            
            const status = questionStatusList[d.index - 1];
            if(status && i === status.selectedIndex) {
                if(status.result === 'correct') b.classList.add('correct');
                else b.classList.add('wrong');
            }
            
            b.onclick = () => { 
                if(questionStatusList[d.index - 1]) return; 
                socket.emit('submitAnswer', {roomCode: myCode, answerIndex: i}); disableAllButtons(); 
            }; 
            area.appendChild(b); myButtons.push(b); 
        });
        
        if(questionStatusList[d.index - 1]) disableAllButtons();
        else document.getElementById('btn-blank').disabled = false;

        const timerBar = document.getElementById('timer-bar');
        const genTimer = document.getElementById('general-timer-display');

        if (d.timerMode === 'question') {
            timerBar.style.display = 'block'; genTimer.style.display = 'none';
            timerBar.style.transition = 'none'; timerBar.style.width = '100%'; 
            setTimeout(() => { timerBar.style.transition = `width ${d.duration}s linear`; timerBar.style.width = '0%'; }, 50);
        } else {
            timerBar.style.display = 'none'; genTimer.style.display = 'block';
            if (d.index === 1 && d.remainingTime) startGlobalCountdown(d.remainingTime);
        }
    });

    socket.on('answerResult', d => {
        if(currentQuestionData) {
            questionStatusList[currentQuestionData.index - 1] = {
                selectedIndex: d.selectedIndex,
                result: d.correct ? 'correct' : (d.selectedIndex === -1 ? 'blank' : 'wrong')
            };
            if(isTrialMode) renderNavigator(currentQuestionData.total, currentQuestionData.index - 1);
        }

        if (currentQuestionData) {
            currentQuestionData.dogru = d.correctIndex;
            saveToHistory(currentQuestionData, 'kpss_favs'); 
            gameHistory.push({ 
                question: currentQuestionData, 
                userAnswerIndex: d.selectedIndex, 
                isCorrect: d.correct, 
                correctAnswerIndex: d.correctIndex,
                earnedPoints: d.points 
            });
            
            if(isMistakeMode && d.correct) {
                let wrongs = getLocalData('kpss_wrongs');
                wrongs = wrongs.filter(q => q.soru !== currentQuestionData.soru);
                saveLocalData('kpss_wrongs', wrongs);
            } 
            else if (!d.correct && !isMistakeMode && d.selectedIndex !== -1) {
                saveToHistory(currentQuestionData, 'kpss_wrongs');
            }
        }
        if(d.points > 0) { document.getElementById('result-msg').innerText = `+${d.points} Puan!`; playSnd('snd-correct'); }
        if(d.isBlank) { myButtons[d.correctIndex].classList.add('correct'); saveToHistory(currentQuestionData, 'kpss_blanks'); }
        else {
            const btn = myButtons[d.selectedIndex];
            if(d.correct) { btn.classList.add('correct'); }
            else { btn.classList.add('wrong'); playSnd('snd-wrong'); myButtons[d.correctIndex].classList.add('correct'); }
        }
    });

    socket.on('gameOver', p => {
        renderResultScreen(p);
    });
    socket.on('errorMsg', m => alert(m));
</script>
</body>
</html>
