<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mert 2210 - Akademi</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); color: #fff; text-align: center; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .container { background: rgba(255,255,255,0.95); color: #333; width: 95%; max-width: 450px; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); position: relative; max-height: 95vh; overflow-y: auto; }
        h2 { margin-top: 0; color: #1e3c72; }
        input, select, button { width: 100%; padding: 12px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-size: 1rem; }
        button { background: #1e3c72; color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button.green { background: #27ae60; }
        button.orange { background: #e67e22; }
        button.red { background: #c0392b; }
        button.outline { background: transparent; border: 2px solid #1e3c72; color: #1e3c72; }
        .screen { display: none; } .active { display: block; }
        
        /* Liste TasarÄ±mÄ± */
        .list-item { background: #fff; border-bottom: 2px solid #f0f2f5; padding: 12px; text-align: left; font-size: 0.85rem; }
        .list-item .q-text { font-weight: bold; color: #333; display: block; margin-bottom: 5px; }
        .list-item .ans-text { color: #27ae60; font-weight: bold; font-size: 0.8rem; background: #e8f5e9; padding: 4px; border-radius: 4px; display: inline-block; }
        
        .player-card { background: #f0f2f5; padding: 8px; margin: 4px 0; border-radius: 5px; display: flex; justify-content: space-between; font-size: 0.9rem; font-weight: bold; }
        .opt-btn { background: #eef2f3; color: #333; text-align: left; border: 2px solid #ddd; }
        .correct { background: #2ecc71 !important; color: white; border-color: #27ae60; }
        .wrong { background: #e74c3c !important; color: white; border-color: #c0392b; }
        #timer-bar { height: 6px; background: #e67e22; width: 100%; margin-top: 10px; border-radius: 3px; }
        .badge { background: #e67e22; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
        #q-image { width: 100%; max-height: 180px; object-fit: contain; margin-bottom: 10px; display: none; border-radius: 8px; }
        #star-btn { font-size: 1.5rem; background: none; border: none; color: #ccc; width: auto; cursor: pointer; padding: 0; line-height: 1; }
        #star-btn.starred { color: #f1c40f; text-shadow: 0 0 5px rgba(241,196,15,0.5); }
        #live-scores-container { margin-top: 15px; border-top: 2px solid #eee; padding-top: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div id="screen-login" class="screen active">
        <h2>MERT 2210</h2>
        <input type="text" id="username" placeholder="AdÄ±nÄ±z">
        <button onclick="createRoom()">ğŸ  ODA KUR</button>
        <div style="display:flex; gap:5px;">
            <input type="number" id="room-code-input" placeholder="Oda Kodu">
            <button onclick="joinRoom()" class="green" style="width:60%;">KATIL</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">
            <button onclick="showLocalList('fav')" class="outline" style="font-size:0.75rem;">â­ YÄ±ldÄ±zlÄ±lar</button>
            <button onclick="showLocalList('wrong')" class="outline" style="font-size:0.75rem;">âŒ YanlÄ±ÅŸlar</button>
            <button onclick="showLocalList('blank')" class="outline" style="font-size:0.75rem; grid-column: span 2;">âšª BoÅŸlarÄ±m</button>
        </div>
    </div>

    <div id="screen-list" class="screen">
        <h3 id="list-title">Liste</h3>
        <div id="list-content" style="max-height: 350px; overflow-y: auto; background: #fff; border-radius: 8px;"></div>
        <button onclick="clearList()" class="red" style="margin-top:10px;">Listeyi Temizle</button>
        <button onclick="showScreen('screen-login')" class="outline">ANA MENÃœ</button>
    </div>

    <div id="screen-lobby" class="screen">
        <p>Oda Kodu:</p>
        <h1 id="display-room-code" style="color:#e67e22; margin:0;">----</h1>
        <div id="lobby-list" style="margin-top:10px;"></div>
        <div id="host-controls" style="display:none; margin-top:20px;">
            <div style="display:flex; gap:5px;">
                <input type="number" id="set-count" value="10">
                <input type="number" id="set-duration" value="15">
            </div>
            <select id="set-subject"><option value="HEPSI">TÃ¼m Dersler</option><option value="TARÄ°H">Tarih</option><option value="COÄRAFYA">CoÄŸrafya</option><option value="VATANDAÅLIK">VatandaÅŸlÄ±k</option></select>
            <select id="set-difficulty"><option value="HEPSI">TÃ¼m Seviyeler</option><option value="KOLAY">Kolay</option><option value="ORTA">Orta</option><option value="ZOR">Zor</option></select>
            <button onclick="startGame()" class="orange" style="margin-top:10px;">OYUNU BAÅLAT</button>
        </div>
        <p id="wait-msg" style="display:none; color:#777;">Kurucu ayarlarÄ± yapÄ±yor...</p>
    </div>

    <div id="screen-game" class="screen">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <span id="q-lesson" class="badge">DERS</span>
            <button id="star-btn" onclick="toggleStar()">â˜…</button>
            <span id="q-count" style="font-weight:bold;">1/10</span>
        </div>
        <img id="q-image" src="">
        <h3 id="q-text" style="font-size:1.1rem; margin:15px 0;">Soru...</h3>
        <div id="opts-area"></div>
        <button id="btn-blank" onclick="submitBlank()" style="background:#95a5a6; margin-top:10px;">âšª BOÅ BIRAK</button>
        <div id="timer-bar"></div>
        <div id="result-msg" style="height: 20px; margin-top: 10px; font-weight: bold; color: #e67e22;"></div>
        
        <div id="live-scores-container">
            <p style="font-size: 0.7rem; color: #888; margin: 0;">ANLIK PUAN DURUMU</p>
            <div id="live-scores-list"></div>
        </div>
    </div>

    <div id="screen-result" class="screen">
        <h2>ğŸ† SONUÃ‡LAR</h2>
        <div id="result-board"></div><br>
        <button onclick="location.reload()" class="outline">ANA MENÃœ</button>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const socket = io();
    let myCode = ""; let myButtons = []; let currentQuestionData = null; let currentListType = "";

    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function getUsername() { return document.getElementById('username').value || null; }
    window.onload = function() { const savedName = localStorage.getItem('saved_username'); if(savedName) document.getElementById('username').value = savedName; }
    
    function getLocalData(key) { return JSON.parse(localStorage.getItem(key)) || []; }
    function saveLocalData(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
    
    // GeÃ§miÅŸe Kaydetme (YanlÄ±ÅŸlar, BoÅŸlar ve Favori GÃ¼ncelleme)
    function saveToHistory(qData, listKey) {
        let list = getLocalData(listKey);
        const idx = list.findIndex(q => q.soru === qData.soru);
        if(idx === -1) { 
            list.push({...qData}); 
            saveLocalData(listKey, list); 
        } else if (qData.dogru !== null) {
            // EÄŸer soru zaten varsa ama cevabÄ± eksikse (favorilerde olabilir), gÃ¼ncelle
            list[idx] = {...qData};
            saveLocalData(listKey, list);
        }
    }

    // YÄ±ldÄ±zlama MantÄ±ÄŸÄ±
    function toggleStar() { 
        if (!currentQuestionData) return; 
        const btn = document.getElementById('star-btn'); 
        let favs = getLocalData('kpss_favs'); 
        const idx = favs.findIndex(q => q.soru === currentQuestionData.soru); 
        
        if (idx > -1) { 
            favs.splice(idx, 1); btn.classList.remove('starred'); 
        } else { 
            favs.push({...currentQuestionData}); btn.classList.add('starred'); 
        } 
        saveLocalData('kpss_favs', favs); 
    }

    // Listeleri GÃ¶rÃ¼ntÃ¼leme
    function showLocalList(type) {
        currentListType = type;
        let key = type === 'fav' ? 'kpss_favs' : (type === 'wrong' ? 'kpss_wrongs' : 'kpss_blanks');
        let title = type === 'fav' ? 'â­ YÄ±ldÄ±zlÄ± Sorular' : (type === 'wrong' ? 'âŒ YanlÄ±ÅŸ YapÄ±lanlar' : 'âšª BoÅŸ BÄ±rakÄ±lanlar');
        const list = getLocalData(key);
        document.getElementById('list-title').innerText = title;
        
        document.getElementById('list-content').innerHTML = list.length === 0 ? 
            "<p style='padding:20px;'>KayÄ±t yok.</p>" : 
            list.map(q => {
                // EÄŸer cevap henÃ¼z iÅŸlenmemiÅŸse (nadiren olabilir) "AÃ§Ä±klanmadÄ±" yazar
                const answerText = (q.dogru !== null && q.siklar) ? q.siklar[q.dogru] : "HenÃ¼z Belirlenmedi";
                return `
                    <div class="list-item">
                        <span class="q-text">${q.soru}</span>
                        <span class="ans-text">âœ… DoÄŸru Cevap: ${answerText}</span>
                    </div>
                `;
            }).join('');
        
        showScreen('screen-list');
    }

    function clearList() { 
        let key = currentListType === 'fav' ? 'kpss_favs' : (currentListType === 'wrong' ? 'kpss_wrongs' : 'kpss_blanks'); 
        if(confirm("Listeyi temizlemek istediÄŸine emin misin?")) {
            localStorage.removeItem(key); showLocalList(currentListType); 
        }
    }

    function createRoom() { const n = getUsername(); if(n) { localStorage.setItem('saved_username', n); socket.emit('createRoom', n); } }
    function joinRoom() { const n = getUsername(); const c = document.getElementById('room-code-input').value; if(n && c) { localStorage.setItem('saved_username', n); myCode = c; socket.emit('joinRoom', {username:n, roomCode:c}); } }
    
    function startGame() { 
        const settings = {
            count: document.getElementById('set-count').value,
            duration: document.getElementById('set-duration').value,
            subject: document.getElementById('set-subject').value,
            difficulty: document.getElementById('set-difficulty').value
        };
        socket.emit('startGame', { roomCode: myCode, settings: settings }); 
    }

    function submitBlank() { socket.emit('submitAnswer', {roomCode: myCode, answerIndex: -1}); disableAllButtons(); }
    function disableAllButtons() { myButtons.forEach(x => x.disabled = true); document.getElementById('btn-blank').disabled = true; }

    socket.on('roomCreated', c => { myCode = c; document.getElementById('display-room-code').innerText = c; showScreen('screen-lobby'); document.getElementById('host-controls').style.display = 'block'; });
    socket.on('roomJoined', c => { myCode = c; document.getElementById('display-room-code').innerText = c; showScreen('screen-lobby'); document.getElementById('wait-msg').style.display = 'block'; });
    
    socket.on('updatePlayerList', p => { 
        const html = p.map(x => `<div class="player-card"><span>${x.username}</span><span>${x.score}</span></div>`).join('');
        document.getElementById('lobby-list').innerHTML = html;
        document.getElementById('live-scores-list').innerHTML = html; 
    });

    socket.on('newQuestion', d => {
        showScreen('screen-game');
        document.getElementById('result-msg').innerText = "";
        // Yeni soruda doÄŸru cevap indexi 'null' olarak baÅŸlar (sunucu gÃ¶ndermez)
        currentQuestionData = { ...d, dogru: null }; 
        
        const isFav = getLocalData('kpss_favs').find(q => q.soru === d.soru);
        document.getElementById('star-btn').classList.toggle('starred', !!isFav);

        document.getElementById('q-lesson').innerText = d.ders + (d.zorluk ? ` (${d.zorluk})` : "");
        document.getElementById('q-count').innerText = d.index + "/" + d.total;
        document.getElementById('q-text').innerText = d.soru;
        const img = document.getElementById('q-image');
        if(d.resim) { img.src = d.resim.startsWith('http') ? d.resim : '/img/' + d.resim; img.style.display = 'block'; } else { img.style.display = 'none'; }
        
        const area = document.getElementById('opts-area'); area.innerHTML = ""; myButtons = [];
        d.siklar.forEach((s, i) => { 
            const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = s; 
            b.onclick = () => { socket.emit('submitAnswer', {roomCode: myCode, answerIndex: i}); disableAllButtons(); }; 
            area.appendChild(b); myButtons.push(b); 
        });
        document.getElementById('btn-blank').disabled = false;
        const bar = document.getElementById('timer-bar'); bar.style.transition = 'none'; bar.style.width = '100%'; setTimeout(() => { bar.style.transition = `width ${d.duration}s linear`; bar.style.width = '0%'; }, 50);
    });

    socket.on('answerResult', d => {
        if(currentQuestionData) {
            currentQuestionData.dogru = d.correctIndex;
            // EÄŸer bu soru favorilerdeyse, cevabÄ±nÄ± oraya da iÅŸle (Ã–NEMLÄ°)
            saveToHistory(currentQuestionData, 'kpss_favs');
        }
        
        if(d.points > 0) document.getElementById('result-msg').innerText = `+${d.points} Puan!`;
        
        if(d.isBlank) { 
            myButtons[d.correctIndex].classList.add('correct'); 
            saveToHistory(currentQuestionData, 'kpss_blanks'); 
        } else {
            const btn = myButtons[d.selectedIndex];
            if(d.correct) { 
                btn.classList.add('correct'); 
            } else { 
                btn.classList.add('wrong'); 
                myButtons[d.correctIndex].classList.add('correct'); 
                saveToHistory(currentQuestionData, 'kpss_wrongs'); 
            }
        }
    });

    socket.on('gameOver', p => { showScreen('screen-result'); p.sort((a,b) => b.score - a.score); document.getElementById('result-board').innerHTML = p.map((x,i) => `<div class="player-card"><span>${i+1}. ${x.username}</span><span>${x.score} P</span></div>`).join(''); });
    socket.on('errorMsg', m => alert(m));
</script>
</body>
</html>
